<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç”µåŠ›è°ƒåº¦æ§åˆ¶ä¸­å¿ƒ - å®‰å…¨æ¥å…¥ç½‘å…³</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Roboto+Mono:wght@400;500&display=swap');

        body {
            background-color: #0b1121;
            font-family: "Microsoft YaHei", 'Rajdhani', sans-serif;
            background-image:
                linear-gradient(rgba(11, 17, 33, 0.92), rgba(11, 17, 33, 0.95)),
                url('https://images.unsplash.com/photo-1558494949-ef526b0042a0?q=80&w=2668&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            overflow: hidden; /* é˜²æ­¢å¼¹çª—å¯¼è‡´æ»šåŠ¨æ¡è·³åŠ¨ */
        }

        .industrial-border {
            border: 1px solid #1e3a8a;
            box-shadow: 0 0 0 1px rgba(30, 58, 138, 0.3), 0 0 20px rgba(37, 99, 235, 0.1);
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-field {
            width: 100%;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            padding: 12px 16px 12px 45px;
            color: #e2e8f0;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-family: 'Roboto Mono', monospace;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            background: rgba(30, 41, 59, 0.8);
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            transition: color 0.3s;
        }

        .input-field:focus + .input-icon { color: #3b82f6; }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border: 1px solid #3b82f6;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }

        /* å¼¹çª—æ ·å¼ */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen flex items-center justify-center relative">

    <div id="app" class="w-full max-w-md p-6 relative z-10">
        <div class="industrial-border rounded-lg p-8 relative">
            <div class="absolute top-0 left-0 w-2 h-2 border-t-2 border-l-2 border-blue-500"></div>
            <div class="absolute top-0 right-0 w-2 h-2 border-t-2 border-r-2 border-blue-500"></div>
            <div class="absolute bottom-0 left-0 w-2 h-2 border-b-2 border-l-2 border-blue-500"></div>
            <div class="absolute bottom-0 right-0 w-2 h-2 border-b-2 border-r-2 border-blue-500"></div>

            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-900/30 mb-4 border border-blue-500/30">
                    <i class="ri-radar-line text-3xl text-blue-400 animate-pulse"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-wider">GRID MASTER <span class="text-blue-500 text-xs align-top">V9.6</span></h1>
                <p class="text-gray-400 text-sm mt-1">ç”µç½‘è°ƒåº¦æ§åˆ¶ç³»ç»Ÿ | å®‰å…¨æ¥å…¥</p>
            </div>

            <form @submit.prevent="handleLogin" class="space-y-4">
                <div class="input-group">
                    <input v-model="form.username" type="text" class="input-field" placeholder="è°ƒåº¦å‘˜å·¥å· / ç”¨æˆ·å" required>
                    <i class="ri-user-line input-icon"></i>
                </div>

                <div class="input-group">
                    <input v-model="form.password" type="password" class="input-field" placeholder="è®¿é—®å¯†é’¥" required>
                    <i class="ri-lock-2-line input-icon"></i>
                </div>

                <div class="flex gap-3 mb-4">
                    <div class="relative flex-1">
                        <input v-model="form.captcha" type="text" class="input-field" placeholder="éªŒè¯ç " required maxlength="4">
                        <i class="ri-shield-keyhole-line input-icon"></i>
                    </div>
                    <div class="w-24 h-[46px] bg-gray-700 rounded border border-gray-600 cursor-pointer overflow-hidden"
                         @click="refreshCaptcha" title="ç‚¹å‡»åˆ·æ–°">
                         <canvas ref="captchaCanvas" width="96" height="46"></canvas>
                    </div>
                </div>

                <div v-if="msg" :class="`text-xs p-2 rounded text-center mb-2 ${msgType==='error'?'bg-red-900/50 text-red-200':'bg-green-900/50 text-green-200'}`">
                    <i :class="msgType==='error'?'ri-error-warning-line':'ri-checkbox-circle-line'"></i> {{ msg }}
                </div>

                <div class="flex justify-between items-center text-sm text-gray-400 mb-6">
                    <label class="flex items-center cursor-pointer hover:text-blue-400">
                        <input type="checkbox" class="mr-2 bg-transparent border-gray-600 rounded focus:ring-0"> è®°ä½è®¾å¤‡
                    </label>
                    <a href="#" @click.prevent="showResetModal=true" class="hover:text-blue-400 transition-colors">å¿˜è®°å¯†ç ?</a>
                </div>

                <button type="submit" :disabled="loading"
                    class="btn-primary w-full text-white font-bold py-3 rounded shadow-lg hover:shadow-blue-500/30 transition-all transform active:scale-95 flex justify-center items-center gap-2">
                    <span v-if="loading"><i class="ri-loader-4-line animate-spin"></i> èº«ä»½éªŒè¯ä¸­...</span>
                    <span v-else>ç«‹å³ç™»å½• <i class="ri-arrow-right-line"></i></span>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-500 text-xs">
                    æœªæ³¨å†Œè®¾å¤‡? <a href="/register.html" class="text-blue-500 hover:text-blue-400 underline decoration-dotted">ç”³è¯·å…¥ç½‘è®¸å¯</a>
                </p>
            </div>
        </div>

        <div class="absolute -bottom-16 left-0 w-full text-center">
            <div class="inline-flex items-center gap-4 text-[10px] text-gray-600 font-mono bg-black/40 px-4 py-1 rounded-full border border-gray-800">
                <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> {{ sysStatus }}</span>
                <span>LATENCY: {{ Math.floor(Math.random()*20+10) }}ms</span>
                <span>ENCRYPTION: AES-256</span>
            </div>
        </div>

        <transition name="modal">
            <div v-if="showResetModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
                <div class="bg-gray-900 border border-blue-500/50 p-8 rounded-lg w-96 shadow-2xl relative">
                    <button @click="showResetModal=false" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                        <i class="ri-close-line text-2xl"></i>
                    </button>

                    <h3 class="text-xl font-bold text-blue-400 mb-1 flex items-center">
                        <i class="ri-lock-password-line mr-2"></i> é‡ç½®å¯†ç 
                    </h3>
                    <p class="text-xs text-gray-500 mb-6">è¯·è¾“å…¥æ‚¨çš„è´¦å·åŠç»‘å®šé‚®ç®±ä»¥éªŒè¯èº«ä»½</p>

                    <div class="space-y-4">
                        <div>
                            <input v-model="resetForm.username" type="text" placeholder="è¾“å…¥ç”¨æˆ·å"
                                class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded focus:border-blue-500 outline-none text-sm transition-colors focus:bg-gray-800/80">
                        </div>

                        <div class="flex gap-2">
                            <input v-model="resetForm.email" type="email" placeholder="ç»‘å®šçš„é‚®ç®±"
                                class="flex-1 bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded focus:border-blue-500 outline-none text-sm">
                            <button @click="sendResetCode" :disabled="timer > 0 || !resetForm.email"
                                class="bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed hover:bg-blue-600 text-white px-3 py-2 rounded text-xs whitespace-nowrap transition-colors min-w-[90px]">
                                {{ timer > 0 ? timer + 's åé‡è¯•' : 'è·å–éªŒè¯ç ' }}
                            </button>
                        </div>

                        <div>
                            <input v-model="resetForm.code" type="text" placeholder="è¯·è¾“å…¥6ä½é‚®ä»¶éªŒè¯ç " maxlength="6"
                                class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded focus:border-blue-500 outline-none text-sm tracking-widest text-center font-mono">
                        </div>

                        <div>
                            <input v-model="resetForm.new_password" type="password" placeholder="è®¾ç½®æ–°å¯†ç "
                                class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded focus:border-blue-500 outline-none text-sm">
                        </div>

                        <button @click="handleReset" :disabled="loading"
                            class="w-full bg-green-700 hover:bg-green-600 text-white py-2 rounded font-bold mt-2 shadow-lg transition-all text-sm flex justify-center items-center">
                            <span v-if="loading"><i class="ri-loader-4-line animate-spin"></i> å¤„ç†ä¸­...</span>
                            <span v-else>ç¡®è®¤é‡ç½®å¯†ç </span>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const loadProgress = ref(0);
                const sysStatus = ref("SYSTEM ONLINE");
                const form = ref({ username: '', password: '', captcha: '' });
                const captchaCode = ref('');
                const captchaCanvas = ref(null);
                const msg = ref('');
                const msgType = ref('error');

                // --- æ‰¾å›å¯†ç ç›¸å…³å˜é‡ ---
                const showResetModal = ref(false);
                const resetForm = ref({ username: '', email: '', code: '', new_password: '' });
                const timer = ref(0);

                // ç”Ÿæˆæœ¬åœ°å›¾å½¢éªŒè¯ç 
                const refreshCaptcha = () => {
                    const ctx = captchaCanvas.value.getContext('2d');
                    ctx.clearRect(0, 0, 96, 46);
                    ctx.fillStyle = '#1e293b';
                    ctx.fillRect(0, 0, 96, 46);

                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                    let code = '';
                    for(let i=0; i<4; i++) {
                        const char = chars[Math.floor(Math.random() * chars.length)];
                        code += char;
                        ctx.font = '24px "Rajdhani"';
                        ctx.fillStyle = `hsl(${Math.random()*360}, 70%, 70%)`;
                        ctx.save();
                        ctx.translate(10 + i*20, 30);
                        ctx.rotate((Math.random() - 0.5) * 0.4);
                        ctx.fillText(char, 0, 0);
                        ctx.restore();
                    }
                    // å¹²æ‰°çº¿
                    for(let i=0; i<3; i++) {
                        ctx.beginPath();
                        ctx.moveTo(Math.random()*96, Math.random()*46);
                        ctx.lineTo(Math.random()*96, Math.random()*46);
                        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                        ctx.stroke();
                    }
                    captchaCode.value = code;
                };

                const showMsg = (text, type='error') => {
                    msg.value = text; msgType.value = type;
                    setTimeout(() => msg.value = '', 3000);
                };

                // --- æ ¸å¿ƒï¼šç™»å½•é€»è¾‘ ---
                const handleLogin = async () => {
                    if(!form.value.captcha || form.value.captcha.toUpperCase() !== captchaCode.value) {
                        showMsg("å›¾å½¢éªŒè¯ç é”™è¯¯"); refreshCaptcha(); return;
                    }
                    loading.value = true;
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: form.value.username, password: form.value.password})
                        });
                        const data = await res.json();
                        if (res.ok) {
                            localStorage.setItem('access_token', data.data.access_token);
                            localStorage.setItem('user_info', JSON.stringify(data.data.user));
                            window.location.href = '/dashboard'; // æˆåŠŸåè·³è½¬
                        } else {
                            showMsg(data.detail || "ç™»å½•å¤±è´¥"); refreshCaptcha();
                        }
                    } catch(e) { showMsg("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨"); }
                    finally { loading.value = false; }
                };

                // --- æ ¸å¿ƒï¼šå‘é€æ‰¾å›å¯†ç éªŒè¯ç  ---
                const sendResetCode = async () => {
                    if(!resetForm.value.username || !resetForm.value.email) {
                        return alert("è¯·å…ˆå¡«å†™ç”¨æˆ·åå’Œé‚®ç®±ï¼Œä»¥ä¾¿ç³»ç»Ÿæ ¸å¯¹èº«ä»½");
                    }
                    try {
                        // å€’è®¡æ—¶é€»è¾‘
                        timer.value = 60;
                        const t = setInterval(() => {
                            timer.value--;
                            if(timer.value <= 0) clearInterval(t);
                        }, 1000);

                        const res = await fetch('/api/auth/send_code', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                email: resetForm.value.email,
                                username: resetForm.value.username,
                                type: 'reset'
                            })
                        });
                        const data = await res.json();
                        if(!res.ok) {
                            alert(data.detail || "å‘é€å¤±è´¥");
                            timer.value = 0; // å¤±è´¥åˆ™é‡ç½®å€’è®¡æ—¶
                        } else {
                            alert("âœ… éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶ï¼");
                        }
                    } catch(e) {
                        alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                        timer.value = 0;
                    }
                };

                // --- æ ¸å¿ƒï¼šæ‰§è¡Œé‡ç½® ---
                const handleReset = async () => {
                    if(!resetForm.value.code || !resetForm.value.new_password) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
                    loading.value = true;
                    try {
                        const res = await fetch('/api/auth/reset_password', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(resetForm.value)
                        });
                        const data = await res.json();
                        if(res.ok) {
                            alert("ğŸ‰ å¯†ç é‡ç½®æˆåŠŸï¼è¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•ã€‚");
                            showResetModal.value = false;
                            resetForm.value = { username:'', email:'', code:'', new_password:'' };
                        } else {
                            alert(data.detail || "é‡ç½®å¤±è´¥");
                        }
                    } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
                    finally { loading.value = false; }
                };

                onMounted(() => {
                    refreshCaptcha();
                    // æ¨¡æ‹Ÿç³»ç»ŸåŠ è½½åŠ¨ç”»
                    const interval = setInterval(() => {
                        if(loadProgress.value < 100) loadProgress.value += 5;
                        else clearInterval(interval);
                    }, 50);
                });

                return {
                    loading, loadProgress, sysStatus, form, captchaCode, captchaCanvas, msg, msgType,
                    handleLogin, refreshCaptcha,
                    // å¯¼å‡ºæ–°åŠŸèƒ½çš„å˜é‡å’Œæ–¹æ³•
                    showResetModal, resetForm, timer, sendResetCode, handleReset
                };
            }
        }).mount('#app');
    </script>
</body>
</html>