<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç”µç½‘è°ƒåº¦æ§åˆ¶ç³»ç»Ÿ (OCS)</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

    <style>
        :root { --bg: #0b1121; --panel: #1e293b; --border: #334155; --text: #cbd5e1; --input-bg: #0f172a; }
        body { background: var(--bg); color: var(--text); font-family: "Microsoft YaHei", sans-serif; overflow: hidden; font-size: 14px; }

        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; }
        .btn-primary { background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; padding: 8px 20px; border-radius: 4px; display: flex; align-items: center; gap: 5px; transition: 0.2s; cursor: pointer; white-space: nowrap; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .top-input { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 4px; text-align: center; }
        .weather-input { background: transparent; border: none; border-bottom: 1px solid #64748b; color: var(--text); width: 80px; font-size: 12px; outline: none; }
        .chat-msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 90%; word-wrap: break-word; font-size: 13px; line-height: 1.5; }
        .chat-ai { background: #3730a3; color: #e9d5ff; align-self: flex-start; }
        .chat-user { background: #1e40af; color: #bfdbfe; align-self: flex-end; text-align: right; }
        .status-card { transition: all 0.3s; position: relative; overflow: hidden; }
        .status-warning { border-color: #eab308 !important; background: rgba(234, 179, 8, 0.1) !important; animation: pulse-yellow 2s infinite; }
        .status-error { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; animation: pulse-red 1s infinite; }

        /* ğŸ”¥ åˆ†ç±»æ ‘æ ·å¼ä¼˜åŒ– */
        details > summary { padding: 10px; cursor: pointer; border-radius: 4px; transition: 0.2s; user-select: none; font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: space-between; }
        details > summary:hover { background: #334155; }
        details[open] > summary { background: #1e293b; border-bottom: 1px solid #334155; margin-bottom: 4px; }
        .node-list-container { max-height: 400px; overflow-y: auto; }
        .node-item { padding: 8px 10px 8px 30px; cursor: pointer; border-left: 3px solid transparent; font-size: 12px; color: #94a3b8; transition: 0.2s; display: flex; justify-content: space-between; }
        .node-item:hover { background: #1e293b; color: white; }
        .node-item.active { background: #1e3a8a; color: #60a5fa; border-left-color: #3b82f6; }

        .city-results { position: absolute; top: 100%; left: 0; width: 200px; background: #1e293b; border: 1px solid #475569; z-index: 50; max-height: 200px; overflow-y: auto; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .city-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #334155; }
        .city-item:hover { background: #334155; }
    </style>
</head>
<body class="h-screen flex flex-col">

<div id="app" class="h-full flex flex-col">

    <header class="h-16 flex items-center justify-between px-6 shrink-0 border-b" style="background: var(--panel); border-color: var(--border)">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded bg-blue-600 flex items-center justify-center text-white text-xl"><i class="ri-radar-line"></i></div>
            <div><h1 class="text-xl font-bold tracking-wide">æ™ºèƒ½ç”µç½‘è°ƒåº¦æ§åˆ¶ç³»ç»Ÿ</h1><div class="text-xs opacity-60">Intelligent Grid Dispatching V9.9 Enterprise</div></div>
        </div>
        <div class="flex gap-8 items-center hidden md:flex">
            <div class="flex items-center gap-3 bg-slate-800/50 px-3 py-1 rounded border border-slate-700 relative">
                <div class="flex items-center gap-2 cursor-pointer" @click="goToWeather" title="ç‚¹å‡»æŸ¥çœ‹åœ°å›¾">
                    <i class="ri-sun-cloudy-line text-xl text-yellow-400"></i>
                    <div class="text-right"><div class="text-xs font-bold">{{ weather.city }} {{ weather.temperature }}Â°C</div><div class="text-[10px] opacity-70">{{ weather.weather }} {{ weather.wind }}</div></div>
                </div>
                <div class="flex items-center gap-1 relative">
                    <input v-if="showCitySearch" v-model="cityKeyword" @keyup.enter="searchCity" @blur="delayCloseSearch" placeholder="è¾“å…¥åŸå¸‚..." class="weather-input" auto-focus>
                    <i v-if="!showCitySearch" @click="showCitySearch=true; nextTick(()=>document.querySelector('.weather-input')?.focus())" class="ri-search-line text-xs cursor-pointer opacity-50 hover:opacity-100"></i>
                    <div v-if="showCitySearch && citySearchResults.length > 0" class="city-results">
                        <div v-for="city in citySearchResults" :key="city.adcode" @mousedown="selectCity(city)" class="city-item">{{ city.name }}</div>
                    </div>
                </div>
            </div>
            <div class="h-8 w-px bg-slate-600"></div>
            <div class="text-center"><div class="text-xs opacity-60">ç”µç½‘é¢‘ç‡</div><div class="text-lg font-bold text-emerald-400">50.02 Hz</div></div>
            <div class="text-center"><div class="text-xs opacity-60">å…¨ç½‘è´Ÿè·</div><div class="text-lg font-bold text-blue-400">45,210 MW</div></div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden md:block"><div class="font-bold">{{ currentTime }}</div></div>
            <div class="flex items-center gap-3">
                <div class="text-right"><div class="text-sm font-bold">{{ userInfo.real_name || userInfo.username }}</div><div class="text-xs text-blue-400">{{ userInfo.role_type }}</div></div>
                <a href="/profile.html" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white overflow-hidden border border-slate-600"><img v-if="avatarUrl" :src="avatarUrl" class="w-full h-full object-cover"><i v-else class="ri-user-settings-line"></i></a>
                <button @click="logout" class="w-10 h-10 rounded-full bg-red-900/50 hover:bg-red-700 text-red-200 flex items-center justify-center"><i class="ri-logout-box-line"></i></button>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden p-3 gap-3" style="background: var(--bg)">

        <aside class="w-72 panel shrink-0 flex flex-col">
            <div class="panel-header p-3 border-b bg-[#161e31]" style="border-color: var(--border)">
                <span class="font-bold text-blue-400"><i class="ri-node-tree mr-2"></i>å…¨ç½‘æ‹“æ‰‘ç»“æ„</span>
            </div>
            <div class="p-3 border-b" style="border-color: var(--border)">
                <input v-model="searchQuery" type="text" placeholder="æœç´¢ ID æˆ– ç±»å‹..." class="w-full text-sm p-2 rounded outline-none" style="background: var(--input-bg); border: 1px solid var(--border); color: var(--text)">
            </div>

            <div class="flex-1 overflow-y-auto p-2 relative">
                <div v-if="topologyLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-[#1e293b]/80 z-10">
                    <i class="ri-loader-4-line animate-spin text-3xl text-blue-500 mb-2"></i>
                    <span class="text-xs text-slate-400">æ­£åœ¨è§£æå…¨ç½‘æ‹“æ‰‘...</span>
                </div>
                <div v-if="!topologyLoading && filteredTopology.length === 0" class="text-center text-xs text-slate-500 mt-10">
                    æœªæ‰¾åˆ°ç›¸å…³èŠ‚ç‚¹
                </div>
                <div v-for="cat in filteredTopology" :key="cat.key">
                    <details class="group mb-2" :open="searchQuery !== '' || cat.key === 'wind' || cat.key === 'solar'">
                        <summary>
                            <span :class="cat.color" class="flex items-center">
                                <i :class="cat.icon" class="mr-2 text-lg"></i> {{ cat.label }}
                            </span>
                            <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300 font-mono">{{ cat.nodes.length }}</span>
                        </summary>
                        <div class="node-list-container mt-1 bg-[#0f172a] rounded">
                            <div v-for="node in cat.nodes.slice(0, 50)" :key="node.id"
                                 @click="targetNodeId=node.id"
                                 :class="['node-item', targetNodeId==node.id?'active':'']">
                                <span class="font-mono">{{ node.name }}</span>
                                <span class="text-[10px] opacity-50">{{ node.voltage }}</span>
                            </div>
                            <div v-if="cat.nodes.length > 50" class="text-[10px] text-center text-slate-600 py-2 cursor-default">... è¿˜æœ‰ {{ cat.nodes.length - 50 }} ä¸ªèŠ‚ç‚¹ ...</div>
                        </div>
                    </details>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col gap-3 min-w-0">
            <div class="flex-1 panel relative p-4 flex flex-col min-h-0 overflow-hidden">
                <div class="flex flex-wrap items-center gap-4 p-3 rounded mb-4 z-10 w-fit shadow-lg shrink-0" style="background: var(--panel); border: 1px solid var(--border)">
                    <div class="flex items-center gap-2">
                        <span class="text-sm opacity-60">èŠ‚ç‚¹:</span>
                        <input v-model.number="targetNodeId" type="number" min="1" max="1351" class="top-input w-20" placeholder="ID">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm opacity-60">æ—¶é—´:</span>
                        <input id="datetime-picker" type="text" class="top-input w-36">
                        <button @click="setToNow" class="text-xs bg-slate-700 px-2 py-1 rounded hover:bg-slate-600 border border-slate-600" title="è®¾ä¸ºå½“å‰æ—¶é—´">å½“å‰</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm opacity-60">æ­¥é•¿(h):</span>
                        <select v-model.number="horizon" class="top-input w-24 bg-[#0f172a] cursor-pointer text-center">
                            <option v-for="h in 24" :key="h" :value="h">é¢„æµ‹ {{ h }} å°æ—¶</option>
                        </select>
                    </div>
                    <label class="flex items-center gap-2 text-xs cursor-pointer select-none border-l border-slate-600 pl-4 ml-2">
                        <input type="checkbox" v-model="showTrueLoad" class="rounded bg-slate-800 border-slate-600">
                        <span>çœŸå®è´Ÿè·(2016)</span>
                    </label>
                    <button @click="executePredict" :disabled="loading" class="btn-primary flex items-center gap-2 ml-auto">
                        <i v-if="loading" class="ri-loader-4-line animate-spin"></i> {{ loading ? 'è®¡ç®—ä¸­...' : 'æ‰§è¡Œé¢„æµ‹' }}
                    </button>
                </div>

                <div class="flex-1 w-full min-h-0 relative bg-slate-900/30 rounded border border-slate-800" ref="chartContainer">
                    <div id="mainChart" class="absolute inset-0 w-full h-full"></div>
                </div>
            </div>

            <div class="h-48 panel p-4 shrink-0">
                <div class="font-bold mb-3 opacity-80 flex justify-between"><span><i class="ri-eye-2-line"></i> å®æ—¶ç›‘è§†</span><span class="text-xs font-normal opacity-50">æ•°æ®æ¯ 5s è‡ªåŠ¨åˆ·æ–°</span></div>
                <div class="grid grid-cols-3 gap-4 h-full">
                    <div @click="openModal('scada')" :class="['status-card cursor-pointer border border-l-4 border-l-emerald-500 p-4 rounded bg-emerald-500/5 hover:bg-emerald-500/10', getCardStatus('scada')]">
                        <div class="flex justify-between items-start">
                            <div><div class="font-bold text-lg text-emerald-500">SCADA é¥æµ‹</div><div class="text-xs opacity-60">å˜ç”µç«™ç»¼åˆè‡ªåŠ¨åŒ–</div></div>
                            <div class="text-right"><div class="text-lg font-mono font-bold">{{ monitorStatus.scada.value || '--' }}</div><div class="text-xs">{{ monitorStatus.scada.message || 'ç³»ç»Ÿæ­£å¸¸' }}</div></div>
                        </div>
                    </div>
                    <div @click="openModal('pmu')" :class="['status-card cursor-pointer border border-l-4 border-l-blue-500 p-4 rounded bg-blue-500/5 hover:bg-blue-500/10', getCardStatus('pmu')]">
                        <div class="flex justify-between items-start">
                            <div><div class="font-bold text-lg text-blue-500">WAMS ç›¸é‡</div><div class="text-xs opacity-60">å¹¿åŸŸåŒæ­¥æµ‹é‡</div></div>
                            <div class="text-right"><div class="text-lg font-mono font-bold">{{ monitorStatus.pmu.data_rate || '--' }}</div><div class="text-xs">{{ monitorStatus.pmu.message || 'ç³»ç»Ÿæ­£å¸¸' }}</div></div>
                        </div>
                    </div>
                    <div @click="openModal('ami')" :class="['status-card cursor-pointer border border-l-4 border-l-orange-500 p-4 rounded bg-orange-500/5 hover:bg-orange-500/10', getCardStatus('ami')]">
                        <div class="flex justify-between items-start">
                            <div><div class="font-bold text-lg text-orange-500">AMI é›†æŠ„</div><div class="text-xs opacity-60">è¥é”€ç”¨ç”µä¿¡æ¯ (ITåŸŸ)</div></div>
                            <div class="text-right"><div class="text-lg font-mono font-bold">{{ monitorStatus.ami.success_rate || '--' }}</div><div class="text-xs">{{ monitorStatus.ami.message || 'ç³»ç»Ÿæ­£å¸¸' }}</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="w-80 panel shrink-0 flex flex-col h-full overflow-hidden">
            <div class="h-[65%] flex flex-col border-b border-slate-700">
                <div class="panel-header p-3 font-bold text-purple-400 bg-[#161e31] shrink-0 border-b border-slate-700"><span><i class="ri-robot-2-line mr-2"></i>AI è°ƒåº¦åŠ©æ‰‹</span></div>
                <div class="flex-1 p-3 overflow-y-auto space-y-3 bg-[#0f172a]" ref="chatBox">
                     <div v-for="(msg, i) in aiMessages" :key="i" :class="['chat-msg text-xs', msg.role==='ai'?'chat-ai':'chat-user']">
                         <div class="flex items-center gap-1 mb-1 opacity-70"><i :class="msg.role==='ai'?'ri-robot-line':'ri-user-line'"></i> {{ msg.role==='ai'?'GridMaster':'Me' }}</div>
                         <div class="whitespace-pre-wrap">{{ msg.text }}</div>
                     </div>
                     <div v-if="aiTyping" class="text-xs text-slate-500 italic pl-2">AI æ­£åœ¨æ€è€ƒ...</div>
                </div>
                <div class="p-2 border-t border-slate-700 bg-[#1e293b] flex gap-2 shrink-0">
                    <input v-model="aiInput" @keyup.enter="sendAi" class="flex-1 top-input text-left" placeholder="è¾“å…¥æŒ‡ä»¤(å¦‚: é£é™©)...">
                    <button @click="sendAi" class="text-purple-400 hover:text-white px-2"><i class="ri-send-plane-fill"></i></button>
                </div>
            </div>

            <div class="h-[35%] flex flex-col bg-[#1e293b]">
                <div class="panel-header p-2 font-bold text-slate-300 border-b border-slate-700 shrink-0"><span><i class="ri-history-line mr-2"></i>ä¸ªäººæ“ä½œå®¡è®¡ (24h)</span></div>
                <div class="flex-1 overflow-y-auto">
                    <div v-for="log in historyLogs" :key="log.op_time + Math.random()" class="p-2 border-b border-slate-700 text-xs flex justify-between opacity-80 hover:bg-slate-700 transition">
                        <span class="opacity-50 font-mono">{{ log.op_time }}</span>
                        <span class="truncate px-2 flex-1">{{ log.action }}</span>
                        <span :class="log.risk_label=='Warning'?'text-yellow-400':(log.risk_label=='Critical'?'text-red-400':'text-emerald-400')">{{ log.risk_label }}</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
        <div class="w-3/4 h-3/4 rounded flex flex-col" style="background: var(--panel); border: 1px solid var(--border)">
            <div class="p-4 border-b flex justify-between font-bold" style="border-color: var(--border)"><span>{{ modalTitle }}</span><button @click="showModal=false"><i class="ri-close-line"></i></button></div>
            <div class="flex-1 p-4 overflow-auto text-sm">
                <div v-if="modalData.length > 0 && modalData[0].access_denied" class="flex flex-col items-center justify-center h-full">
                    <i class="ri-lock-2-line text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-xl font-bold text-white mb-2">{{ modalData[0].message }}</h2>
                    <p class="text-slate-400">{{ modalData[0].reason }}</p>
                </div>
                <table v-else class="w-full text-left border-collapse">
                    <thead style="border-bottom: 1px solid var(--border)"><tr><th>æ—¶é—´</th><th>æµ‹ç‚¹/å‚æ•°</th><th>æ•°å€¼</th><th>è´¨é‡/çŠ¶æ€</th></tr></thead>
                    <tbody>
                        <template v-for="row in modalData" :key="row.timestamp">
                            <template v-if="row.yc_points">
                                <tr v-for="pt in row.yc_points" class="border-b border-slate-700"><td class="p-2 opacity-70">{{ row.timestamp }}</td><td class="p-2 text-blue-400">{{ pt.name }}</td><td class="p-2 font-bold">{{ pt.value }} {{ pt.unit }}</td><td class="p-2 text-emerald-500">{{ pt.quality }}</td></tr>
                            </template>
                            <template v-else-if="row.synchrophasor">
                                <tr class="border-b border-slate-700"><td class="p-2 opacity-70">{{ row.timestamp }}</td><td class="p-2">ç”µå‹å¹…å€¼/ç›¸è§’</td><td class="p-2 font-bold">{{ row.synchrophasor.voltage.magnitude }} {{ row.synchrophasor.voltage.unit }} âˆ  {{ row.synchrophasor.voltage.angle }}</td><td class="p-2 text-emerald-500">{{ row.quality.sync_status }}</td></tr>
                            </template>
                            <template v-else-if="row.data">
                                <tr class="border-b border-slate-700"><td class="p-2 opacity-70">{{ row.timestamp }}</td><td class="p-2">{{ row.user_id }}</td><td class="p-2 font-bold">{{ row.data.current_power }} kW</td><td class="p-2 text-blue-400">{{ row.encryption.status }}</td></tr>
                            </template>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="toast.show" :class="['fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded shadow-xl font-bold z-[100]', toast.type==='error'?'bg-red-600 text-white':'bg-emerald-600 text-white']">{{ toast.message }}</div>

</div>

<script>
    const { createApp, ref, onMounted, computed, nextTick, watch, onUnmounted } = Vue;
    createApp({
        setup() {
            const userInfo = ref(JSON.parse(localStorage.getItem('user_info') || '{}'));
            const avatarUrl = ref(localStorage.getItem('user_avatar') || '');
            const currentTime = ref('');

            const targetNodeId = ref(2);
            const horizon = ref(24);
            const loading = ref(false);
            const showTrueLoad = ref(false);
            const toast = ref({ show: false, message: '', type: 'success' });

            const topologyCategories = ref([]);
            const topologyLoading = ref(true);
            const searchQuery = ref('');

            const weather = ref({ city: 'å®šä½ä¸­...', temperature: '--', weather: '--', wind: '', humidity: '', url: '#' });
            const selectedCity = ref('local');
            const showCitySearch = ref(false);
            const cityKeyword = ref('');
            const citySearchResults = ref([]);

            const aiMessages = ref([{role:'ai', text:'è°ƒåº¦åŠ©æ‰‹å·²å°±ç»ªã€‚è¯·è¾“å…¥èŠ‚ç‚¹IDè¿›è¡Œé¢„æµ‹ï¼Œæˆ–ç›´æ¥æé—®ã€‚'}]);
            const aiInput = ref('');
            const chatBox = ref(null);
            const aiTyping = ref(false);
            const monitorStatus = ref({ scada: {}, pmu: {}, ami: {} });
            const historyLogs = ref([]);
            const showModal = ref(false);
            const modalData = ref([]);
            const modalTitle = ref('');

            let chart = null;
            let cachedChartData = null;
            const chartContainer = ref(null);
            let resizeObserver = null;

            // ğŸ”¥ æ ¸å¿ƒï¼šè·å–æ‹“æ‰‘é€»è¾‘ (å¸¦å…œåº•æ•°æ®)
            const fetchTopology = async () => {
                topologyLoading.value = true;
                try {
                    const res = await fetch('/api/topology/structure', { headers: {'Authorization': `Bearer ${getToken()}`} });
                    if(res.ok) {
                        topologyCategories.value = await res.json();
                    } else {
                        throw new Error("API Error");
                    }
                } catch(e) {
                    console.warn("æ‹“æ‰‘åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å…œåº•æ•°æ®", e);
                    // å…œåº•æ•°æ®ï¼Œä¿è¯ UI ä¸ç©º
                    topologyCategories.value = [
                        {key: 'wind', label: 'é£åŠ›å‘ç”µ (Wind) - ç¦»çº¿', icon: 'ri-windy-line', color: 'text-gray-400', nodes: Array.from({length:10},(_,i)=>({id:i+1, name:`Node ${i+1}`, voltage:'220kV'}))},
                        {key: 'solar', label: 'å…‰ä¼å‘ç”µ (Solar) - ç¦»çº¿', icon: 'ri-sun-line', color: 'text-gray-400', nodes: []},
                        {key: 'thermal', label: 'ç«åŠ›å‘ç”µ (Thermal) - ç¦»çº¿', icon: 'ri-fire-line', color: 'text-gray-400', nodes: []}
                    ];
                    showToast("æ‹“æ‰‘è§£ææœåŠ¡æœªå“åº”ï¼Œå±•ç¤ºç¼“å­˜", "warning");
                } finally {
                    topologyLoading.value = false;
                }
            };

            const filteredTopology = computed(() => {
                if (!searchQuery.value) return topologyCategories.value;
                const query = searchQuery.value.toLowerCase();
                return topologyCategories.value.map(cat => {
                    const matchesName = cat.label.toLowerCase().includes(query);
                    const matchingNodes = cat.nodes.filter(n => n.id.toString().includes(query) || n.name.toLowerCase().includes(query));
                    if (matchesName) return cat;
                    if (matchingNodes.length === 0) return null;
                    return { ...cat, nodes: matchingNodes };
                }).filter(cat => cat !== null);
            });

            const getToken = () => localStorage.getItem('access_token');
            const showToast = (msg, type = 'success') => { toast.value = { show: true, message: msg, type }; setTimeout(() => toast.value.show = false, 3000); };
            const updateClock = () => { currentTime.value = new Date().toLocaleString('zh-CN', { hour12: false }); };
            const canAccess = (type) => { const role = userInfo.value.role_type; if(role=='SUPER_ADMIN') return true; if(role=='ADMIN' || role=='OPERATOR') return type!='ami'; return false; };

            const fetchWeather = async () => { try { const res = await fetch('/api/weather/current'); if(res.ok) weather.value = await res.json(); } catch(e) {} };
            const handleCityChange = () => { if (selectedCity.value === 'search') { showCitySearch.value = true; nextTick(() => document.querySelector('.weather-input')?.focus()); } else fetchWeather(); };
            const searchCity = async () => { if (!cityKeyword.value) return; try { const res = await fetch(`/api/weather/search?keywords=${encodeURIComponent(cityKeyword.value)}`); const data = await res.json(); if (data && data.length > 0) { citySearchResults.value = data; } else showToast('æœªæ‰¾åˆ°åŸå¸‚', 'error'); } catch (e) { showToast('æœç´¢å¤±è´¥', 'error'); } };
            const selectCity = async (city) => { try { const res = await fetch(`/api/weather/city/${city.adcode}`); if (res.ok) { weather.value = await res.json(); showCitySearch.value = false; cityKeyword.value = ''; citySearchResults.value = []; showToast(`å·²åˆ‡æ¢è‡³ ${city.name}`); } } catch(e){} };
            const delayCloseSearch = () => { setTimeout(() => showCitySearch.value = false, 200); };
            const goToWeather = () => { if(weather.value.url && weather.value.url!='#') window.open(weather.value.url, '_blank'); };

            const executePredict = async () => {
                if (!targetNodeId.value) return showToast("è¯·è¾“å…¥èŠ‚ç‚¹ID", "error");
                loading.value = true;
                try {
                    const res = await fetch('/api/predict/execute', {
                        method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}`},
                        body: JSON.stringify({ bus_id: targetNodeId.value, start_time: document.getElementById('datetime-picker').value, horizon: horizon.value })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        cachedChartData = data.chart_data;
                        updateChart();
                        getAIAutoReport();
                        fetchHistory();
                        showToast("é¢„æµ‹æˆåŠŸ");
                    } else showToast(data.detail, "error");
                } catch (e) { showToast("æœåŠ¡å™¨é”™è¯¯", "error"); }
                finally { loading.value = false; }
            };

            const updateChart = () => {
                if (!cachedChartData || !chart) return;
                const series = [{ name: 'é¢„æµ‹å€¼', type: 'line', data: cachedChartData.pred_vals, smooth: true, itemStyle: { color: '#3b82f6' }, areaStyle: { opacity: 0.3 } }];

                if (showTrueLoad.value) {
                    const hasRealData = cachedChartData.truth_vals && cachedChartData.truth_vals.some(v => v !== null);
                    if (hasRealData) {
                        series.push({ name: 'çœŸå®å€¼', type: 'line', data: cachedChartData.truth_vals, smooth: true, itemStyle: { color: '#10b981' }, lineStyle: { type: 'dashed' }, connectNulls: false });
                    } else {
                        showTrueLoad.value = false;
                        showToast("å½“å‰æ—¶æ®µæ— çœŸå®è´Ÿè·æ•°æ®", "warning");
                    }
                }
                chart.setOption({ xAxis: { data: cachedChartData.time_axis }, series: series }, { replaceMerge: ['series'] });
            };

            watch(showTrueLoad, () => { if(cachedChartData) updateChart(); });

            const sendAi = async () => {
                if (!aiInput.value) return;
                aiMessages.value.push({ role: 'user', text: aiInput.value });
                const msg = aiInput.value; aiInput.value = '';
                scrollToBottom(); aiTyping.value = true;
                try {
                    const res = await fetch('/api/ai/chat', { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}`}, body: JSON.stringify({ message: msg }) });
                    const data = await res.json();
                    if (res.ok) aiMessages.value.push({ role: 'ai', text: data.message });
                } catch (e) {}
                aiTyping.value = false; scrollToBottom();
            };
            const getAIAutoReport = async () => { try { const res = await fetch('/api/ai/auto-report', { headers: {'Authorization': `Bearer ${getToken()}`} }); const data = await res.json(); if (res.ok && data.success) { aiMessages.value.push({ role: 'ai', text: data.report }); scrollToBottom(); } } catch (e) {} };
            const scrollToBottom = () => { nextTick(() => { if(chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight; }); };

            const openModal = async (type) => { if (!canAccess(type)) return showToast("æƒé™ä¸è¶³: " + (type=='ami'?'AMIä»…é™è¶…ç®¡':'éœ€æ“ä½œå‘˜æƒé™'), "error"); modalTitle.value = type.toUpperCase() + " å®æ—¶æ•°æ®"; showModal.value = true; modalData.value = []; try { const res = await fetch(`/api/collect/detail?source_type=${type}`, { headers: {'Authorization': `Bearer ${getToken()}`} }); if (res.ok) modalData.value = await res.json(); } catch (e) {} };
            const updateMonitorStatus = async () => { try { const res = await fetch('/api/monitor/overview'); if(res.ok) monitorStatus.value = await res.json(); } catch(e) {} };
            const getCardStatus = (type) => { const s = monitorStatus.value[type]?.status; return s === 'warning' ? 'status-warning' : (s === 'error' ? 'status-error' : ''); };
            const fetchHistory = async () => { try { const res = await fetch('/api/history', { headers: {'Authorization': `Bearer ${getToken()}`} }); if(res.ok) historyLogs.value = await res.json(); } catch(e) {} };
            const logout = () => { localStorage.removeItem('access_token'); location.href='/'; };
            const syncProfile = async () => { try { const res = await fetch('/api/user/profile', { headers: {'Authorization': `Bearer ${getToken()}`} }); if(res.ok) { const d=await res.json(); userInfo.value=d.data.user; if(d.data.user.avatar) avatarUrl.value=d.data.user.avatar; } } catch(e){} };

            const setToNow = () => {
                const now = new Date();
                const str = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,'0') + "-" + String(now.getDate()).padStart(2,'0') + " " + String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
                document.getElementById('datetime-picker')._flatpickr.setDate(str);
            };

            onMounted(() => {
                syncProfile();
                fetchTopology();
                setInterval(updateClock, 1000); updateClock();
                fetchWeather(); fetchHistory(); updateMonitorStatus();
                setInterval(updateMonitorStatus, 5000);

                chart = echarts.init(document.getElementById('mainChart'), 'dark', { backgroundColor: 'transparent' });
                chart.setOption({ tooltip: { trigger: 'axis' }, legend: { bottom: 10 }, grid: { top: 40, right: 20, bottom: 60, left: 60 }, xAxis: { type: 'category', data: [], axisLine: { lineStyle: { color: '#64748b' } } }, yAxis: { type: 'value', name: 'è´Ÿè· (MW)', axisLine: { lineStyle: { color: '#64748b' } }, splitLine: { lineStyle: { color: '#334155', type: 'dashed' } } }, series: [] });

                // ğŸ”¥ åŒé‡ä¿é™©çš„ Resize ç›‘å¬
                if (chartContainer.value) {
                    resizeObserver = new ResizeObserver(() => { if (chart) chart.resize(); });
                    resizeObserver.observe(chartContainer.value);
                }
                window.addEventListener('resize', () => { if (chart) chart.resize(); });

                flatpickr("#datetime-picker", { enableTime: true, dateFormat: "Y-m-d H:i", defaultDate: "2016-01-15 08:00", locale: "zh", time_24hr: true, theme: "dark" });
            });

            onUnmounted(() => {
                if (resizeObserver) resizeObserver.disconnect();
                if (chart) chart.dispose();
            });

            return {
                userInfo, avatarUrl, currentTime, searchQuery, filteredTopology, targetNodeId, loading, showTrueLoad,
                weather, selectedCity, showCitySearch, cityKeyword, citySearchResults, handleCityChange, searchCity, selectCity, delayCloseSearch, goToWeather,
                executePredict, aiInput, aiMessages, aiTyping, sendAi, chatBox, historyLogs, showModal, modalTitle, modalData,
                openModal, monitorStatus, getCardStatus, canAccess, logout, toast, horizon, setToNow,
                topologyCategories, topologyLoading, chartContainer
            };
        }
    }).mount('#app');
</script>
</body>
</html>