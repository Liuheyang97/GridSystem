<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç«™å†…é€šä¿¡ - GridMaster</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body { background-color: #0b1121; color: #cbd5e1; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        .panel { background: #1e293b; border-right: 1px solid #334155; }

        .chat-item { padding: 14px; border-bottom: 1px solid #334155; cursor: pointer; transition: 0.2s; position: relative; }
        .chat-item:hover { background: #2d3748; }
        .chat-item.active { background: #334155; border-left: 4px solid #6366f1; }

        .msg-bubble {
            max-width: 75%; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px;
            font-size: 16px; line-height: 1.6; position: relative; word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .msg-mine { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background: #334155; color: #f1f5f9; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-system {
            align-self: center; width: 95%; background: rgba(30, 41, 59, 0.8);
            border: 1px solid #ef4444; border-left: 4px solid #ef4444; color: #e2e8f0;
            padding: 15px; font-size: 15px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .chat-img { max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: transform 0.2s; }
        .chat-img:hover { transform: scale(1.02); }

        /* æ–‡ä»¶é“¾æ¥æ ·å¼ä¼˜åŒ– */
        .file-link {
            color: #e2e8f0; text-decoration: none; display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; margin-top: 5px;
            width: fit-content; border: 1px solid rgba(255,255,255,0.2); transition: 0.2s;
        }
        .file-link:hover { background: rgba(255,255,255,0.2); }
        .file-icon { font-size: 24px; color: #60a5fa; }

        .badge { position: absolute; right: 12px; top: 12px; background: #ef4444; color: white; font-size: 11px; font-weight: bold; padding: 2px 7px; border-radius: 99px; }

        .emoji-picker {
            position: absolute; bottom: 60px; left: 10px; background: #1e293b; border: 1px solid #475569;
            padding: 10px; border-radius: 8px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 50; width: 240px;
        }
        .emoji-item { cursor: pointer; font-size: 20px; text-align: center; padding: 4px; border-radius: 4px; transition: 0.2s; }
        .emoji-item:hover { background: #334155; transform: scale(1.2); }

        .custom-scroll { overflow-y: auto; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex flex-col">

<div id="app" class="h-full flex flex-col">
    <header class="h-16 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 shrink-0 z-10">
        <div class="flex items-center gap-4">
            <a href="/dashboard" class="text-slate-400 hover:text-white transition group"><div class="flex items-center gap-1"><i class="ri-arrow-left-line text-xl group-hover:-translate-x-1 transition"></i><span class="text-sm">è¿”å›æ§åˆ¶å°</span></div></a>
            <div class="h-6 w-px bg-slate-700"></div>
            <h1 class="text-lg font-bold text-white flex items-center gap-2"><i class="ri-chat-voice-line text-indigo-500"></i> ç«™å†…é€šä¿¡ä¸­å¿ƒ</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right"><div class="text-xs text-slate-400">å½“å‰ç™»å½•</div><div class="text-sm font-bold text-white">{{ currentUser.real_name || currentUser.username }}</div></div>
            <div class="w-9 h-9 rounded bg-indigo-600 flex items-center justify-center text-white font-bold border border-indigo-400">{{ (currentUser.username||'U')[0].toUpperCase() }}</div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <aside class="w-80 panel flex flex-col shrink-0 z-10">
            <div class="p-4 border-b border-slate-700 bg-[#172030]">
                <div class="relative"><i class="ri-search-line absolute left-3 top-2.5 text-slate-500"></i><input v-model="keyword" placeholder="æœç´¢è”ç³»äºº..." class="w-full bg-slate-800 border border-slate-600 rounded-lg pl-9 pr-3 py-2 text-sm text-white outline-none focus:border-indigo-500 transition"></div>
            </div>

            <div class="flex-1 custom-scroll">
                <div @click="selectUser(systemUser)" :class="['chat-item flex items-center gap-3', targetUser.user_id===0?'active':'']">
                    <div class="w-12 h-12 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center border border-red-500/30 text-xl shrink-0"><i class="ri-notification-3-fill"></i></div>
                    <div class="flex-1 min-w-0"><div class="font-bold text-white text-sm flex justify-between"><span>ç³»ç»Ÿé€šçŸ¥</span><span class="text-[10px] bg-red-600 text-white px-1.5 py-0.5 rounded ml-1">OFFICIAL</span></div><div class="text-xs text-slate-400 mt-1 truncate">å…¨ç«™å¹¿æ’­ / å‘Šè­¦</div></div>
                </div>

                <div class="px-4 py-2 text-[10px] text-slate-500 font-bold uppercase tracking-wider bg-[#1a2332]">è”ç³»äººåˆ—è¡¨</div>

                <div v-for="u in filteredUsers" :key="u.user_id" @click="selectUser(u)" :class="['chat-item flex items-center gap-3', targetUser.user_id===u.user_id?'active':'']">
                    <div class="relative w-11 h-11 shrink-0">
                        <div class="w-full h-full rounded-full bg-slate-700 flex items-center justify-center overflow-hidden border border-slate-600">
                            <img v-if="u.avatar" :src="u.avatar" class="w-full h-full object-cover">
                            <span v-else class="text-indigo-300 font-bold">{{ u.username[0].toUpperCase() }}</span>
                        </div>
                        <div :class="['absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-[#1e293b]', u.is_online ? 'bg-emerald-500' : 'bg-slate-500']" :title="u.is_online?'åœ¨çº¿':'ç¦»çº¿'"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-white text-sm truncate">{{ u.real_name || u.username }}</div>
                        <div class="text-xs text-slate-500 truncate flex items-center gap-1">
                            <span :class="{'text-yellow-500': u.role_type==='SUPER_ADMIN', 'text-blue-400': u.role_type==='ADMIN'}">{{ u.role_type }}</span>
                            <span v-if="u.is_online" class="text-emerald-500 ml-1 scale-90 origin-left">Online</span>
                        </div>
                    </div>
                    <div v-if="u.unread_count > 0" class="badge">{{ u.unread_count > 99 ? '99+' : u.unread_count }}</div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#0f172a] relative min-w-0">
            <div class="h-16 border-b border-slate-700 flex items-center px-6 bg-[#131b2e] shrink-0 shadow-sm z-10">
                <div v-if="targetUser.username">
                    <div class="font-bold text-white text-lg flex items-center gap-2">
                        {{ targetUser.real_name || targetUser.username }}
                        <span v-if="targetUser.user_id===0" class="text-xs border border-red-500 text-red-400 px-2 rounded">å…¨å‘˜å¹¿æ’­é¢‘é“</span>
                    </div>
                    <div v-if="targetUser.user_id!==0" class="text-xs flex items-center gap-1 mt-0.5">
                        <span :class="targetUser.is_online ? 'text-emerald-400' : 'text-slate-500'">{{ targetUser.is_online ? 'â— å½“å‰åœ¨çº¿' : 'â— ç¦»çº¿' }}</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 custom-scroll p-6 flex flex-col" ref="msgBox">
                <div v-for="msg in messages" :key="msg.id" :class="['msg-bubble', getMsgClass(msg)]">
                    <div v-if="getMsgClass(msg) === 'msg-system'">
                        <div class="text-red-400 font-bold mb-1 flex items-center gap-1"><i class="ri-alarm-warning-fill"></i> ç³»ç»Ÿå…¬å‘Š</div>
                        <div class="whitespace-pre-wrap text-slate-200" v-html="msg.content.replace(/è¶…çº§ç®¡ç†å‘˜.*é€šçŸ¥ï¼Œè¯·æŸ¥æ”¶ï¼š/, '')"></div>
                        <div class="mt-3 pt-2 border-t border-red-500/30 flex justify-between items-center text-xs opacity-60">
                            <span>å‘å¸ƒäºº: {{ msg.sender_name || 'System' }}</span><span>{{ msg.created_at }}</span>
                        </div>
                    </div>
                    <div v-else>
                        <div class="whitespace-pre-wrap" v-html="msg.content"></div>
                        <div class="text-[10px] opacity-50 text-right mt-1.5 select-none font-mono flex items-center justify-end gap-1">
                            <i v-if="msg.sender_id === currentUser.user_id && msg.is_read" class="ri-check-double-line text-emerald-400" title="å·²è¯»"></i>
                            {{ msg.created_at }}
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="canSend" class="h-48 border-t border-slate-700 bg-[#161e31] p-4 relative shrink-0">
                <div class="flex gap-4 text-slate-400 mb-2 px-1 relative select-none">
                    <i @click="showEmoji=!showEmoji" class="ri-emotion-line hover:text-white cursor-pointer text-lg" title="è¡¨æƒ…"></i>

                    <i @click="triggerUpload('image')" class="ri-image-line hover:text-white cursor-pointer text-lg" title="å‘é€å›¾ç‰‡"></i>

                    <i @click="triggerUpload('file')" class="ri-file-line hover:text-white cursor-pointer text-lg" title="å‘é€æ–‡ä»¶"></i>

                    <div v-if="showEmoji" class="emoji-picker" @mouseleave="showEmoji=false">
                        <div v-for="e in emojis" :key="e" @click="addEmoji(e)" class="emoji-item">{{e}}</div>
                    </div>
                </div>

                <input type="file" ref="imageInput" class="hidden" accept="image/*" @change="handleUpload($event, 'image')">
                <input type="file" ref="fileInput" class="hidden" @change="handleUpload($event, 'file')">

                <textarea v-model="inputText" @keyup.enter.ctrl="sendMessage" placeholder="è¾“å…¥æ¶ˆæ¯ (Ctrl+Enter å‘é€)..." class="w-full h-24 bg-transparent outline-none text-white resize-none text-base placeholder-slate-600"></textarea>
                <div class="absolute bottom-4 right-4 flex items-center gap-2">
                    <span class="text-xs text-slate-500 mr-2">Ctrl + Enter å‘é€</span>
                    <button @click="sendMessage" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded shadow-lg transition flex items-center gap-2"><i class="ri-send-plane-fill"></i> å‘é€</button>
                </div>
            </div>
            <div v-else class="p-4 text-center text-slate-500 text-sm bg-slate-900 border-t border-slate-800 h-16 flex items-center justify-center shrink-0">
                <i class="ri-lock-2-line mr-2"></i> ç³»ç»Ÿé€šçŸ¥é¢‘é“ä»…ä¾›æŸ¥çœ‹ï¼Œæ— æ³•å›å¤ã€‚
            </div>
        </main>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed, nextTick } = Vue;
    createApp({
        setup() {
            const currentUser = ref({});
            const userList = ref([]);
            const keyword = ref('');
            const targetUser = ref({});
            const messages = ref([]);
            const inputText = ref('');
            const msgBox = ref(null);

            const showEmoji = ref(false);
            const imageInput = ref(null); // å¼•ç”¨å›¾ç‰‡ Input
            const fileInput = ref(null);  // å¼•ç”¨æ–‡ä»¶ Input
            const emojis = ['ğŸ˜€','ğŸ˜‚','ğŸ˜Š','ğŸ˜','ğŸ¤”','ğŸ˜','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‘','ğŸ‰','ğŸ”¥','ğŸ’¡','ğŸš€','ğŸ’»','ğŸ”§','âš¡','â¤ï¸','âœ…','âŒ'];

            const systemUser = { user_id: 0, username: 'ç³»ç»Ÿé€šçŸ¥', real_name: 'GridMaster å®˜æ–¹', role_type: 'SYSTEM' };
            let pollTimer = null;

            const getToken = () => localStorage.getItem('access_token');
            const headers = () => ({ 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' });

            const init = async () => {
                const u = localStorage.getItem('user_info');
                if(!u) location.href = '/';
                currentUser.value = JSON.parse(u);
                await fetchContacts();
                selectUser(systemUser);
                pollTimer = setInterval(() => { fetchContacts(); if(targetUser.value.user_id !== undefined) fetchHistory(targetUser.value.user_id, false); }, 3000);
            };

            const fetchContacts = async () => {
                try { const res = await fetch(`/api/chat/contacts`, { headers: headers() }); userList.value = await res.json(); } catch(e) {}
            };

            const filteredUsers = computed(() => {
                if(!keyword.value) return userList.value;
                const k = keyword.value.toLowerCase();
                return userList.value.filter(u => u.username.toLowerCase().includes(k) || (u.real_name && u.real_name.toLowerCase().includes(k)));
            });

            const canSend = computed(() => targetUser.value.user_id !== 0 || (targetUser.value.user_id === 0 && currentUser.value.role_type === 'SUPER_ADMIN'));

            const selectUser = (u) => {
                if (targetUser.value.user_id === u.user_id) return;
                messages.value = []; targetUser.value = u; fetchHistory(u.user_id, true);
                const userInList = userList.value.find(user => user.user_id === u.user_id);
                if (userInList) userInList.unread_count = 0;
            };

            const fetchHistory = async (uid, forceScroll = false) => {
                try {
                    const res = await fetch(`/api/chat/history?partner_id=${uid}`, { headers: headers() });
                    const newMsgs = await res.json();
                    if (newMsgs.length > messages.value.length || forceScroll) { messages.value = newMsgs; scrollToBottom(); }
                } catch(e) {}
            };

            const sendMessage = async (content = null) => {
                const txt = content || inputText.value;
                if(!txt.trim()) return;
                try {
                    const res = await fetch('/api/chat/send', {
                        method: 'POST', headers: headers(),
                        body: JSON.stringify({ receiver_id: targetUser.value.user_id, content: txt })
                    });
                    if(res.ok) { if(!content) inputText.value = ''; fetchHistory(targetUser.value.user_id, true); }
                    else alert((await res.json()).detail);
                } catch(e) {}
            };

            const addEmoji = (e) => { inputText.value += e; showEmoji.value = false; };

            // ğŸ”¥ è§¦å‘å™¨ï¼šæ ¹æ®ç±»å‹ç‚¹ä¸åŒçš„ Input
            const triggerUpload = (type) => {
                if (type === 'image') imageInput.value.click();
                else fileInput.value.click();
            };

            const handleUpload = async (e, type) => {
                const file = e.target.files[0];
                if(!file) return;
                const formData = new FormData(); formData.append('file', file);

                try {
                    const res = await fetch('/api/chat/upload', { method: 'POST', headers: {'Authorization': `Bearer ${getToken()}`}, body: formData });
                    const d = await res.json();
                    if(res.ok) {
                        let html = '';
                        if(d.type === 'image') {
                            html = `<img src="${d.url}" class="chat-img" onclick="window.open('${d.url}')">`;
                        } else {
                            html = `<a href="${d.url}" target="_blank" class="file-link"><i class="ri-file-download-line text-2xl"></i> <div><div class="font-bold">é™„ä»¶: ${d.name}</div><div class="text-[10px] opacity-60">ç‚¹å‡»ä¸‹è½½</div></div></a>`;
                        }
                        sendMessage(html);
                    } else alert("ä¸Šä¼ å¤±è´¥");
                } catch(err) { alert("ç½‘ç»œé”™è¯¯"); }
                e.target.value = '';
            };

            const getMsgClass = (msg) => {
                if(msg.receiver_id === 0 || msg.sender_id === 0) return 'msg-system';
                if(msg.sender_id === currentUser.value.user_id) return 'msg-mine';
                return 'msg-other';
            };

            const scrollToBottom = () => { nextTick(() => { setTimeout(() => { if(msgBox.value) msgBox.value.scrollTop = msgBox.value.scrollHeight; }, 50); }); };

            onMounted(init);

            return {
                currentUser, filteredUsers, keyword, targetUser, messages, inputText, canSend,
                selectUser, sendMessage, getMsgClass, systemUser, msgBox,
                showEmoji, emojis, addEmoji,
                imageInput, fileInput, triggerUpload, handleUpload // æš´éœ²æ–°å˜é‡
            };
        }
    }).mount('#app');
</script>
</body>
</html>