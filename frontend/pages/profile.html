<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸ªäººä¸­å¿ƒ - GridMaster</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #0b1121; color: #cbd5e1; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .card-header { background: #0f172a; padding: 10px 20px; border-bottom: 1px solid #334155; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center; }
        .form-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; display: block; }
        .form-input { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; width: 100%; border-radius: 4px; font-size: 13px; transition: 0.3s; }
        .form-input:focus { border-color: #3b82f6; outline: none; }
        .modal-mask { background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .admin-table th { background: #0f172a; text-align: left; padding: 10px; color: #94a3b8; border-bottom: 1px solid #334155; }
        .admin-table td { padding: 10px; border-bottom: 1px solid #334155; color: white; }
        .admin-table tr:hover { background: #1e293b; }

        /* New helper classes for dynamic badges */
        .badge-active { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.4); }
        .badge-locked { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); }
    </style>
</head>
<body class="p-4 h-screen flex flex-col">

<div id="app" class="h-full flex flex-col max-w-7xl mx-auto w-full gap-4">

    <div class="flex items-center justify-between shrink-0">
        <h1 class="text-xl font-bold text-white flex items-center gap-3">
            <a href="/dashboard" class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center hover:bg-slate-700 text-slate-400 transition"><i class="ri-arrow-left-line"></i></a>
            ä¸ªäººä¿¡æ¯ç®¡ç†ä¸­å¿ƒ
        </h1>
        <div class="flex gap-4 items-center">
            <a href="/chat.html" target="_blank" class="text-xs bg-indigo-900/50 text-indigo-300 border border-indigo-500/30 px-3 py-1 rounded hover:bg-indigo-900 transition flex items-center gap-1">
                <i class="ri-chat-4-line"></i> ç«™å†…ä¿¡
            </a>
            <div class="text-xs text-slate-500 bg-slate-900 px-3 py-1 rounded border border-slate-800">
                <i class="ri-shield-check-line text-emerald-500 mr-1"></i> {{ user.username }}
            </div>
        </div>
    </div>

    <div class="flex-1 flex gap-4 overflow-hidden">
        <div class="w-1/3 flex flex-col gap-4 overflow-y-auto pr-1">
            <div class="card p-6 space-y-4 shrink-0">
                <div class="flex flex-col items-center border-b border-slate-700 pb-6">
                    <div class="relative group cursor-pointer" @click="triggerFileUpload">
                        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-3xl font-bold text-white shadow-xl overflow-hidden border-4 border-slate-700">
                            <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover">
                            <span v-else>{{ (user.username||'U')[0].toUpperCase() }}</span>
                        </div>
                        <div class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-xs text-white">
                            ä¸Šä¼ å›¾ç‰‡
                        </div>
                    </div>
                    <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" style="display: none;">

                    <h2 class="text-xl font-bold text-white mt-3">{{ user.real_name || user.username }}</h2>
                    <div class="text-blue-400 text-xs mt-1 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-500/30">{{ permissions.role_label || user.role_type }}</div>
                </div>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="form-label">å·¥å·</label><input v-model="user.employee_id" class="form-input" placeholder="SG-001"></div>
                        <div><label class="form-label">æ€§åˆ«</label><select v-model="extra.gender" class="form-input"><option>ç”·</option><option>å¥³</option><option>ä¿å¯†</option></select></div>
                    </div>
                    <div><label class="form-label">çœŸå®å§“å</label><input v-model="user.real_name" class="form-input"></div>
                    <div><label class="form-label">éƒ¨é—¨</label><input v-model="user.department" class="form-input"></div>
                    <div><label class="form-label">è”ç³»åœ°å€</label><input v-model="extra.address" class="form-input"></div>
                    <div class="border-t border-slate-700 pt-3 mt-2"><label class="form-label text-emerald-400">è”ç³»é‚®ç®± (å¿…å¡«)</label><input v-model="user.email" class="form-input border-emerald-500/30"></div>
                    <div><label class="form-label">æ‰‹æœºå·ç </label><input v-model="user.phone" class="form-input"></div>
                    <button @click="saveProfile" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>

            <div class="card p-4 shrink-0 border border-red-900/50 bg-red-900/10">
                <div class="flex justify-between items-center">
                    <div class="text-xs text-red-300"><div class="font-bold">å±é™©åŒºåŸŸ</div>æ°¸ä¹…æ³¨é”€æ‚¨çš„è´¦æˆ·</div>
                    <button @click="deleteAccount" class="bg-red-600 hover:bg-red-500 text-white text-xs px-3 py-1.5 rounded">æ³¨é”€è´¦æˆ·</button>
                </div>
            </div>
        </div>

        <div class="w-2/3 flex flex-col gap-4 overflow-y-auto pr-2">
            <div class="card shrink-0">
                <div class="card-header"><span><i class="ri-shield-keyhole-line mr-2 text-purple-400"></i>æƒé™ä¸æ•°æ®åŸŸè§†å›¾</span></div>
                <div class="p-5 grid grid-cols-2 gap-4">
                    <div v-for="(domain, index) in permissions.access_domains" :key="index"
                         :class="domain.status === 'active' ? 'border-emerald-500/30 bg-emerald-500/5' : 'border-red-500/30 bg-red-500/5'"
                         class="border p-3 rounded flex items-center gap-3">
                        <div :class="domain.status === 'active' ? 'bg-emerald-900/50 text-emerald-400' : 'bg-red-900/50 text-red-400'"
                             class="w-10 h-10 rounded flex items-center justify-center text-xl">
                             <i :class="domain.status === 'active' ? 'ri-checkbox-circle-fill' : 'ri-lock-2-fill'"></i>
                        </div>
                        <div>
                            <div :class="domain.status === 'active' ? 'text-emerald-400' : 'text-red-400'" class="font-bold text-sm">{{ domain.name }}</div>
                            <div class="text-xs text-slate-400">{{ domain.desc }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shrink-0">
                <div class="card-header"><span><i class="ri-lock-password-line mr-2 text-emerald-400"></i>è´¦æˆ·å®‰å…¨</span></div>
                <div class="p-5 flex gap-6">
                    <div class="space-y-3 w-1/2">
                        <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded border border-slate-700">
                            <div><div class="font-bold text-white text-sm">ç™»å½•å¯†ç </div><div class="text-xs text-slate-500">å»ºè®®å®šæœŸä¿®æ”¹</div></div>
                            <button @click="openPwdModal" class="text-blue-400 hover:text-white text-xs border border-blue-500/30 px-3 py-1 rounded">ä¿®æ”¹</button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded border border-slate-700">
                            <div><div class="font-bold text-white text-sm">åŒå› ç´ è®¤è¯ (2FA)</div><div class="text-xs text-slate-500">ç™»å½•éœ€äºŒæ¬¡éªŒè¯</div></div>
                            <div @click="toggleMFA" :class="permissions.mfa_enabled?'bg-emerald-600':'bg-slate-600'" class="w-8 h-4 rounded-full relative cursor-pointer transition"><div :class="permissions.mfa_enabled?'translate-x-4':'translate-x-0'" class="w-4 h-4 bg-white rounded-full shadow-md transform transition duration-300"></div></div>
                        </div>
                    </div>
                    <div class="w-1/2 pl-6 border-l border-slate-700">
                        <h4 class="text-xs font-bold text-slate-400 mb-2">æœ€è¿‘å®¡è®¡æ—¥å¿—</h4>
                        <div class="space-y-2 h-24 overflow-y-auto pr-1">
                            <div v-for="log in logs" class="text-xs flex justify-between border-b border-slate-800 pb-1">
                                <span class="text-slate-300">{{ log.created_at }}</span><span class="text-emerald-500">{{ log.operation_type || 'æ“ä½œ' }}</span>
                            </div>
                            <div v-if="logs.length === 0" class="text-xs text-slate-600 text-center py-4">æš‚æ— è®°å½•</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shrink-0">
                <div class="card-header"><span><i class="ri-settings-4-line mr-2 text-yellow-400"></i>é€šçŸ¥åå¥½</span></div>
                <div class="p-5">
                    <div>
                        <label class="form-label text-white">è´Ÿè·å‘Šè­¦æ–¹å¼</label>
                        <select v-model="userPreferences.alert_method" class="form-input bg-[#131b2e] border-slate-600">
                            <option value="site">ä»…ç«™å†…ä¿¡</option>
                            <option value="email">ç«™å†…ä¿¡ + é‚®ä»¶æ¨é€</option>
                            <option value="both">ç«™å†…ä¿¡ + é‚®ä»¶ + çŸ­ä¿¡</option>
                        </select>
                        <p class="text-[10px] text-slate-500 mt-2">é€‰"é‚®ä»¶"éœ€å…ˆåœ¨å·¦ä¾§å¡«å†™é‚®ç®±ã€‚</p>
                    </div>
                </div>
            </div>

            <div class="card shrink-0 border-t-4 border-t-red-600" v-if="permissions.can_edit_system">
                <div class="card-header"><span class="text-red-400"><i class="ri-admin-fill mr-2"></i>ç³»ç»Ÿç®¡ç†ä¸“åŒº</span></div>
                <div class="p-5 flex justify-between items-center">
                    <div class="text-sm text-slate-400">æ‚¨æ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„è§’è‰²ä¸æ•°æ®è®¿é—®çº§åˆ«ã€‚</div>
                    <button @click="openAdminPanel" class="bg-red-900/50 border border-red-600 text-red-200 hover:bg-red-800 px-4 py-2 rounded font-bold transition flex items-center gap-2">
                        <i class="ri-settings-6-line"></i> ç”¨æˆ·æƒé™ç®¡ç†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showPwdModal" class="fixed inset-0 modal-mask flex items-center justify-center z-50">
        <div class="bg-slate-800 border border-slate-600 p-6 rounded-lg w-96 shadow-2xl">
            <h3 class="text-lg font-bold text-white mb-4">ä¿®æ”¹å¯†ç </h3>
            <div class="space-y-4">
                <input v-model="pwdForm.old" type="password" class="form-input" placeholder="æ—§å¯†ç ">
                <input v-model="pwdForm.new" type="password" class="form-input" placeholder="æ–°å¯†ç ">
                <input v-model="pwdForm.confirm" type="password" class="form-input" placeholder="ç¡®è®¤æ–°å¯†ç ">
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="changePassword" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded">ç¡®è®¤</button>
                <button @click="showPwdModal=false" class="flex-1 bg-slate-700 text-slate-300 py-2 rounded">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div v-if="showAdminModal" class="fixed inset-0 modal-mask flex items-center justify-center z-50 p-10">
        <div class="bg-slate-900 border border-slate-600 w-full max-w-5xl h-full max-h-[800px] rounded-xl flex flex-col shadow-2xl relative">
            <button @click="showAdminModal=false" class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl"><i class="ri-close-circle-line"></i></button>
            <div class="p-6 border-b border-slate-700 bg-slate-800/50 rounded-t-xl">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3"><i class="ri-admin-line text-red-500"></i> ç”¨æˆ·æƒé™ç®¡ç†æ§åˆ¶å°</h2>
            </div>
            <div class="flex-1 p-6 overflow-y-auto">
                <table class="admin-table">
                    <thead><tr><th>ID</th><th>å·¥å·</th><th>ç”¨æˆ·å</th><th>å§“å</th><th>è§’è‰²</th><th>æœ€åç™»å½•</th><th>æ“ä½œ</th></tr></thead>
                    <tbody>
                        <tr v-for="u in userList" :key="u.user_id">
                            <td class="font-mono text-slate-500">#{{ u.user_id }}</td>
                            <td class="text-blue-300">{{ u.employee_id || '-' }}</td>
                            <td class="font-bold text-white">{{ u.username }}</td>
                            <td>{{ u.real_name }}</td>
                            <td>
                                <select v-if="u.user_id !== user.user_id" v-model="u.role_type" @change="updateRole(u)" class="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                                    <option value="SUPER_ADMIN">SUPER_ADMIN</option>
                                    <option value="ADMIN">ADMIN</option>
                                    <option value="OPERATOR">OPERATOR</option>
                                    <option value="VIEWER">VIEWER</option>
                                </select>
                                <span v-else class="text-red-500 text-xs font-bold">SUPER_ADMIN</span>
                            </td>
                            <td class="text-xs text-slate-500">{{ u.last_login }}</td>
                            <td class="flex gap-2">
                                <button @click="checkUserLogs(u)" class="text-blue-400 hover:text-white text-xs border border-blue-500/30 px-2 py-1 rounded">å®¡è®¡</button>
                                <button v-if="u.user_id !== user.user_id" @click="deleteUser(u)" class="text-red-400 hover:text-white text-xs border border-red-500/30 px-2 py-1 rounded">åˆ é™¤</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="show2FAModal" class="fixed inset-0 modal-mask flex items-center justify-center z-50">
        <div class="bg-slate-800 border border-slate-600 p-6 rounded-lg w-96 shadow-2xl text-center">
            <h3 class="font-bold text-lg mb-2 text-white">ç»‘å®šè™šæ‹Ÿ MFA</h3>
            <p class="text-xs text-slate-400 mb-4">è¯·ä½¿ç”¨ Google Authenticator æ‰«æ</p>

            <div id="qrcode" class="w-32 h-32 mx-auto mb-4 flex items-center justify-center bg-white p-2 rounded overflow-hidden">
                </div>

            <input v-model="mfaCode" type="text" placeholder="è¾“å…¥6ä½éªŒè¯ç " class="form-input text-center tracking-widest text-lg mb-4">
            <div class="flex gap-2">
                <button @click="confirmMFA" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm hover:bg-blue-500">éªŒè¯å¹¶å¼€å¯</button>
                <button @click="show2FAModal=false" class="flex-1 bg-slate-700 text-slate-300 py-2 rounded text-sm hover:bg-slate-600">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div v-if="showLogModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[60]">
        <div class="bg-slate-800 border border-slate-600 w-[600px] h-[500px] rounded-lg flex flex-col shadow-2xl">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-white">å®¡è®¡æ—¥å¿—: {{ currentAuditUser }}</h3>
                <button @click="showLogModal=false" class="text-slate-400 hover:text-white"><i class="ri-close-line text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div v-for="(log, i) in targetUserLogs" :key="i" class="text-xs bg-slate-900 p-3 rounded border-l-4 border-blue-500 flex justify-between">
                    <div><div class="text-slate-300 font-bold mb-1">{{ log.operation_type }}</div><div class="text-slate-500">{{ log.created_at }}</div></div>
                    <div class="text-right"><div class="text-slate-400">{{ log.ip_address }}</div></div>
                </div>
                <div v-if="targetUserLogs.length===0" class="text-center text-slate-500 mt-10">æ— è®°å½•</div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, nextTick, computed } = Vue;
    createApp({
        setup() {
            const user = ref({});
            const permissions = ref({ access_domains: [], mfa_enabled: false, role_label: '' });
            const logs = ref([]);
            const extra = ref({ gender: 'ä¿å¯†', address: '' });
            const userPreferences = ref({ alert_method: 'site' });
            const fileInput = ref(null);

            const showPwdModal = ref(false);
            const pwdForm = ref({ old: '', new: '', confirm: '' });
            const show2FAModal = ref(false);
            const mfaCode = ref('');

            const showAdminModal = ref(false);
            const showLogModal = ref(false);
            const userList = ref([]);
            const targetUserLogs = ref([]);
            const currentAuditUser = ref('');
            const tempSecret = ref('');

            const isSuperAdmin = computed(() => user.value.role_type === 'SUPER_ADMIN');
            const getToken = () => localStorage.getItem('access_token');
            const headers = () => ({ 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' });

            const fetchProfile = async () => {
                try {
                    const res = await fetch('/api/user/profile', { headers: headers() });
                    if(res.ok) {
                        const json = await res.json();
                        user.value = json.data.user;
                        permissions.value = json.data.permissions;

                        if(user.value.preferences) userPreferences.value = user.value.preferences;
                        logs.value = json.data.logs || []; // ğŸ”¥ æ ¸å¿ƒï¼šåŠ è½½å®¡è®¡æ—¥å¿—

                        const savedExtra = localStorage.getItem('user_extra');
                        if(savedExtra) extra.value = JSON.parse(savedExtra);
                    } else if(res.status===401) location.href='/';
                } catch(e) {}
            };

            const saveProfile = async () => {
                try {
                    user.value.preferences = userPreferences.value;
                    const res = await fetch('/api/user/profile', { method: 'PUT', headers: headers(), body: JSON.stringify(user.value) });
                    localStorage.setItem('user_extra', JSON.stringify(extra.value));
                    if(res.ok) alert("ä¿å­˜æˆåŠŸ");
                } catch(e) { alert("ä¿å­˜å¤±è´¥"); }
            };

            // ğŸ”¥ 2FA Fix: ä½¿ç”¨åç«¯ç”Ÿæˆçš„å›¾ç‰‡ Base64ï¼Œä¸ä½¿ç”¨ qrcode.js æ¸²æŸ“
            const toggleMFA_Fixed = async () => {
                 if(permissions.value.mfa_enabled) {
                    if(confirm("å…³é—­2FA?")) {
                        await fetch('/api/user/2fa/disable', { method: 'POST', headers: headers() });
                        permissions.value.mfa_enabled = false;
                        alert("2FAå·²å…³é—­");
                    }
                } else {
                    try {
                        const res = await fetch('/api/user/2fa/generate', { headers: headers() });
                        if(res.ok) {
                            const data = await res.json();
                            tempSecret.value = data.secret;
                            show2FAModal.value = true;

                            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥æ’å…¥ img æ ‡ç­¾æ˜¾ç¤ºå›¾ç‰‡ï¼Œä¸å†è°ƒç”¨ new QRCode()
                            nextTick(() => {
                                const container = document.getElementById("qrcode");
                                container.innerHTML = `<img src="${data.qrcode}" style="width:100%; height:100%">`;
                            });
                        } else {
                            alert("ç”Ÿæˆå¤±è´¥ï¼Œç¼ºå°‘ä¾èµ–åº“");
                        }
                    } catch(e) {
                        console.error(e);
                        alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                    }
                }
            };

            const confirmMFA_Fixed = async () => {
                const res = await fetch('/api/user/2fa/enable', {
                    method: 'POST', headers: headers(),
                    body: JSON.stringify({ secret: tempSecret.value, code: mfaCode.value })
                });
                if(res.ok) {
                    permissions.value.mfa_enabled = true;
                    show2FAModal.value = false;
                    alert("2FAå·²å¼€å¯");
                } else {
                    alert("éªŒè¯ç é”™è¯¯");
                }
            };

            const triggerFileUpload = () => fileInput.value.click();
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const formData = new FormData(); formData.append('file', file);
                try {
                    const res = await fetch('/api/user/avatar', { method: 'POST', headers: { 'Authorization': `Bearer ${getToken()}` }, body: formData });
                    const data = await res.json();
                    if(res.ok) { user.value.avatar = data.url; alert("å¤´åƒä¸Šä¼ æˆåŠŸ"); }
                } catch(e) {}
            };

            const openAdminPanel = async () => {
                try {
                    const res = await fetch('/api/admin/users', { headers: headers() });
                    if(res.ok) { userList.value = (await res.json()).data; showAdminModal.value = true; }
                    else alert("æ— æƒè®¿é—®");
                } catch(e) {}
            };
            const updateRole = async (target) => {
                try { await fetch('/api/admin/user/role', { method: 'POST', headers: headers(), body: JSON.stringify({ user_id: target.user_id, role_type: target.role_type }) }); alert("ä¿®æ”¹æˆåŠŸ"); } catch(e){}
            };
            const deleteUser = async (target) => {
                if(!confirm("ç¡®å®šåˆ é™¤?")) return;
                try { await fetch(`/api/admin/user/${target.user_id}`, { method: 'DELETE', headers: headers() }); alert("åˆ é™¤æˆåŠŸ"); openAdminPanel(); } catch(e){}
            };
            const checkUserLogs = async (targetUser) => {
                currentAuditUser.value = targetUser.username;
                try {
                    const res = await fetch(`/api/admin/user/${targetUser.user_id}/logs`, { headers: headers() });
                    targetUserLogs.value = await res.json(); showLogModal.value = true;
                } catch(e) {}
            };
            const changePassword = async () => {
                if(pwdForm.value.new!==pwdForm.value.confirm) return alert("å¯†ç ä¸ä¸€è‡´");
                try { await fetch('/api/user/password', { method: 'POST', headers: headers(), body: JSON.stringify({ old_password: pwdForm.value.old, new_password: pwdForm.value.new }) }); alert("ä¿®æ”¹æˆåŠŸ"); showPwdModal.value=false; } catch(e){ alert("ä¿®æ”¹å¤±è´¥"); }
            };
            const openPwdModal = () => { pwdForm.value={old:'',new:'',confirm:''}; showPwdModal.value=true; };
            const deleteAccount = async () => {
                if(!confirm("âš ï¸ ç¡®å®šæ³¨é”€è´¦æˆ·ï¼Ÿæ“ä½œä¸å¯æ’¤é”€ï¼")) return;
                try {
                    const res = await fetch(`/api/admin/user/${user.value.user_id}`, { method: 'DELETE', headers: headers() });
                    if(res.ok) { alert("è´¦æˆ·å·²æ³¨é”€"); location.href='/'; }
                } catch(e) {}
            };

            onMounted(fetchProfile);

            return {
                user, logs, extra, userPreferences, fileInput, showPwdModal, pwdForm, show2FAModal, mfaCode,
                showAdminModal, showLogModal, userList, targetUserLogs, currentAuditUser,
                saveProfile, toggleMFA: toggleMFA_Fixed, confirmMFA: confirmMFA_Fixed, triggerFileUpload, handleFileUpload,
                openAdminPanel, updateRole, deleteUser, checkUserLogs, changePassword, openPwdModal, deleteAccount,
                permissions, isSuperAdmin
            };
        }
    }).mount('#app');
</script>
</body>
</html>